; Себеотнасящ се оценител :Р
(определи (оцени израз среда)
  (условие ((самооценяващ? израз) израз)
        ((променлива? израз) (извлечи-стойност-на-променлива израз среда))
        ((цитат? израз) (думи-на-цитата израз))
        ((присвояване? израз) (оцени-присвояване израз среда))
        ((определение? израз) (оцени-определение израз среда))
        ((ако? израз) (оцени-ако израз среда))
        ((безименно-действие? израз)
         (създай-действие (действие-вход израз)
                         (действие-тяло израз)
                         среда))
        ((почни? израз) 
         (оцени-последователност (почни-действия израз) среда))
        ((условие? израз) (оцени (условие->ако израз) среда))
        ((приложение? израз)
         (приложи (оцени (име-действие израз) среда)
                (списък-стойности (вход израз) среда)))
        (иначе
         (предизвикай "Неизвестен вид израз -- ОЦЕНИ"))))
; приложение
(определи първично-приложи приложи)
(определи (приложи действие вход)
  (условие ((първично-действие? действие)
         (приложи-първично-действие действие вход))
        ((съставно-действие? действие)
         (оцени-последователност
           (действие-тяло действие)
           (разшири-среда
             (действие-вход действие)
             вход
             (среда-на-действие действие))))
        (иначе
         (предизвикай "Нейзвестен вид действие -- ПРИЛОЖИ"))))

(определи (списък-стойности изрази среда)
  (ако (няма-вход? изрази)
      '()
      (конс (оцени (начало-вход изрази) среда)
            (списък-стойности (остатък-вход изрази) среда))))
(определи (оцени-ако израз среда)
  (ако ((оцени (ако-проверка израз) среда))
      (оцени (ако-тогава израз) среда)
      (оцени (ако-иначе израз) среда)))
(определи (оцени-последователност изрази среда)
  (условие ((последен-израз? изрази) (оцени (първи-израз изрази) среда))
        (иначе (оцени (първи-израз изрази) среда)
              (оцени-последователност (остатък-изрази изрази) среда))))
(определи (оцени-присвояване израз среда)
  (смени-стойност-променлива! (променлива-присвояване израз)
                       (eval (стойност-присвояване израз) среда)
                       среда)
  'тъй)
(определи (оцени-определение израз среда)
  (определи-променлива! (променлива-определение израз)
                    (eval (стойност-определение израз) среда)
                    среда)
  'тъй)
(определи (самооценяващ? израз)
  (условие ((число? израз) #в)
        ((низ? израз) #в)
        (иначе #л)))
(определи (променлива? израз) (символ? израз))
(определи (цитат? израз)
  (белязан-списък? израз 'цитат))
(определи (думи-цитат израз) (първторо израз))
(определи (белязан-списък? израз белег)
  (ако (двойка? израз)
      (ра? (първо израз) белег)
      #л))
(определи (присвояване? израз)
  (белязан-списък? израз 'смени!))
(определи (променлива-присвояване израз) (първторо израз))
(определи (стойност-присвояване израз) (първо (първторо израз)))
(определи (определение? израз)
  (белязан-списък? израз 'определи))
(определи (променлива-определение израз)
  (ако (символ? (първторо израз))
      (първторо израз)
      (първо (първторо израз))))
(определи (стойност-определение израз)
  (if (символ? (първторо израз))
      (първо (първторо израз))
      (създай-действие (второ (първторо израз)); вход
                   (втовторо израз)))); тяло
(определи (безименно-действие? израз) (белязан-списък? израз 'действие))
(определи (безименно-действие-вход израз) (първторо израз))
(определи (безименно-действие-тяло израз) (втовторо израз))
(определи (създай-безименно-действие вход тяло)
  (конс 'действие (конс вход тяло)))
(определи (ако? израз) (белязан-списък? израз 'ако))
(определи (ако-проверка израз) (първторо израз))
(определи (ако-тогава израз) (първо (втовторо израз)))
(определи (ако-иначе израз)
  (ако (не (нищо? (второ (втовторо израз))))
      (първо (второ (втовторо израз)))
      #л))
(определи (създай-ако проверка тогава иначе-)
  (списък 'ако проверка тогава иначе-))
(определи (почни? израз) (белязан-списък? израз 'почни))
(определи (почни-действия израз) (второ израз))
(определи (последен-израз? последователност) (нищо? (второ последователност)))
(определи (първи-израз последователност) (първо последователност))
(определи (остатък-изрази последователност) (второ последователност))
(определи (последователност->израз последователност)
  (условие ((нищо? последователност) последователност)
        ((последен-израз? последователност) (първи-израз последователност))
        (иначе (създай-почни последователност))))
(определи (създай-почни последователност) (конс 'почни последователност))
(определи (приложение? израз) (двойка? израз))
(определи (име-действие израз) (първо израз))
(определи (вход израз) (второ израз))
(определи (няма-вход? вход) (нищо? вход))
(определи (начало-вход вход) (първо вход))
(определи (остатък-вход вход) (второ вход))
(определи (условие? израз) (белязан-списък? израз 'условие))
(определи (случаи-условие израз) (второ израз))
(определи (случай-условие-иначе? случай-)
  (ра? (проверка-условие случай-) 'иначе))
(определи (проверка-условие случай-) (първо случай-))
(определи (действия-условие случай-) (второ случай-))
(определи (условие->ако израз)
  (разшири-случаи (случаи-условие израз)))
(определи (разшири-случаи случаи)
  (ако (нищо? случаи)
      #л; няма случай за иначе
      (нека ((първи-случай (първо случаи))
            (остатък-случаи (второ случаи)))
        (ако (случай-условие-иначе? първи-случай)
            (ако (нищо? остатък-случаи)
                (последователност->израз (действия-условие първи-случай))
                (предизвикай "случай ИНАЧЕ не е последен -- УСЛОВИЕ->АКО"))
            (създай-ако (проверка-условие първи-случай)
                     (последователност->израз (действия-условие първи-случай))
                     (разшири-случаи остатък-случаи))))))
(определи (създай-действие вход тяло среда)
  (списък 'действие вход тяло среда))
(определи (съставно-действие? действие)
  (белязан-списък? действие 'действие))
(определи (действие-вход действие) (първторо действие))
(определи (действие-тяло действие) (първо (втовторо действие)))
(определи (действие-среда действие) (първо (втовторо (втовторо p))))
(определи (обхващаща-среда среда) (второ среда))
(определи (първа-рамка среда) (първо среда))
(определи празна-среда '())
(определи (създай-рамка променливи стойности)
  (конс променливи стойности))
(определи (променливи-рамка рамка) (първо рамка))
(определи (стойности-рамка рамка) (второ рамка))
(определи (добави-свързване-към-рамка! променлива стойност рамка)
  (смени-първо! рамка (конс променлива (първо рамка)))
  (смени-второ! рамка (конс стойност (второ рамка))))
(определи (разшири-среда променливи стойности основна-рамка)
  (ако (= (дължина променливи) (дължина стойности))
      (конс (създай-рамка променливи стойности) основна-рамка)
      (ако (< (дължина променливи) (дължина стойности))
          (предизвикай "Променливите са по-малко от стойностите")
          (предизвикай "Стойностите са по-малко от променливите"))))
(определи (извлечи-стойност-на-променлива променлива среда)
  (определи (среда-повторение среда)
    (определи (прегледай променливи стойности)
      (условие ((нищо? променливи)
             (среда-повторение (обхващаща-среда среда)))
            ((ра? променлива (първо променливи))
             (първо стойности))
            (иначе (прегледай (второ променливи) (второ стойности)))))
    (ако (ра? среда празна-среда)
        (предизвикай (низ-добави "Несвързана променлива " (символ->низ променлива)))
        (нека ((рамка (първа-рамка среда)))
          (прегледай (променливи-рамка рамка)
                (стойности-рамка рамка)))))
  (среда-повторение среда))
(определи (смени-стойност-променлива! променлива стойност среда)
  (определи (среда-повторение среда)
    (определи (прегледай променливи стойности)
      (условие ((нищо? променливи)
             (среда-повторение (обхващаща-среда среда)))
            ((ра? променлива (първо променливи))
             (смени-първо! стойности стойност))
            (иначе (прегледай (второ променливи) (второ стойности)))))
    (ако (ра? среда празна-среда)
        (предизвикай
          (низ-добави "Несвързана променлива " (символ->низ променлива) " -- СМЕНИ!")
        (нека ((рамка (първа-рамка среда)))
          (прегледай (променливи-рамка рамка)
                (стойности-рамка рамка))))))
  (среда-повторение среда))
(определи (определи-променлива! променлива стойност среда)
  (нека ((рамка (първа-рамка среда)))
    (определи (прегледай променливи стойности)
      (условие ((нищо? променливи)
             (добави-свързване-към-рамка! променлива стойност рамка))
            ((ра? променлива (първо променливи))
             (смени-първо! стойности стойност))
            (иначе (прегледай (второ променливи) (второ стойности)))))
    (прегледай (променливи-рамка рамка)
          (стойности-рамка рамка))))
(определи (построй-среда)
  (нека ((първоначална-среда
         (разшири-среда (имена-първични-действия)
                             (стойности-първични-действия)
                             празна-среда)))
    първоначална-среда))
(определи (първично-действие? действие)
  (белязан-списък? действие 'първично))
(определи (осъществяване-първично-действие действие) (първторо действие))
(определи първични-действия
  (списък (списък 'първо първо)
        (списък 'второ второ)
        (списък 'конс конс)
        (списък 'нищо? нищо?)
        (списък '+ +)
        ;още първични действия
        ))
(определи (имена-първични-действия)
  (съотнеси първо
       първични-действия))
(определи (стойности-първични-действия)
  (съотнеси (функция (действие) (списък 'първично (първторо действие)))
       първични-действия))
(определи (приложи-първично-действие действие вход)
  (първично-приложи
   (осъществяване-първично-действие действие) вход))
(определи (съотнеси действие списък)
  (определи (повторение списък)
    (ако (нищо? списък)
      списък
      (конс (действие (първо списък)) (повторение (второ списък)))))
  (повторение списък))
(определи световна-среда (построй-среда))

(оцени '(+ 1 2) световна-среда)